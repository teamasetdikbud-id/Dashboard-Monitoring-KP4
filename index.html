<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Analytics - DISDIKPORA DONGGALA</title>
    <!-- Framework & Library Externals -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 17 & ReactDOM 17 untuk stabilitas maksimal dalam file tunggal -->
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <!-- Babel untuk kompilasi JSX di browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.1.12/umd/Recharts.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        :root { --primary: #8b5cf6; --secondary: #ec4899; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #fbfaff; margin: 0; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(139, 92, 246, 0.1); }
        .recharts-cartesian-grid-horizontal line, .recharts-cartesian-grid-vertical line { stroke: #f3f4f6; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Script harus bertipe text/babel agar JSX diproses oleh Babel -->
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { 
            PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, CartesianGrid, 
            Tooltip: RechartsTooltip, Legend, AreaChart, Area, ResponsiveContainer 
        } = Recharts;

        const Icon = ({ name, className = "w-5 h-5" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        const PIE_COLORS = ['#8b5cf6', '#ec4899', '#3b82f6', '#10b981', '#f59e0b'];

        const getGeneration = (date) => {
            if (!date) return null;
            const year = new Date(date).getFullYear();
            if (isNaN(year)) return null;
            if (year >= 1997) return 'Gen Z';
            if (year >= 1981) return 'Millennial';
            if (year >= 1965) return 'Gen X';
            return 'Boomer';
        };

        const ChartCard = ({ title, desc, children }) => (
            <div className="glass-card p-6 rounded-3xl shadow-sm flex flex-col h-[400px] transition-all hover:shadow-xl hover:-translate-y-1">
                <div className="mb-4">
                    <h3 className="text-xl font-extrabold text-gray-800 leading-tight">{title}</h3>
                    <p className="text-sm text-gray-500 font-medium">{desc}</p>
                </div>
                <div className="flex-grow w-full h-full relative">
                    {children}
                </div>
            </div>
        );

        const App = () => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('profil');

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const response = await fetch('https://script.google.com/macros/s/AKfycbwcDsqULBGPwsCcGRFyxJ_YCbDgK4BNfjD03xVpP6OHGJVBOWlBHM9inUDg1_lrcpD8/exec');
                        const result = await response.json();
                        const raw = Array.isArray(result) ? result : (result.data || []);
                        raw.length > 0 ? setData(raw) : loadMockData();
                    } catch (e) { loadMockData(); }
                    finally { setLoading(false); }
                };
                const loadMockData = () => {
                    const mock = Array.from({ length: 100 }).map((_, i) => ({
                        "JENIS KELAMIN": i % 2 === 0 ? 'Laki-laki' : 'Perempuan',
                        "STATUS KEPEGAWAIAN": i % 3 === 0 ? 'PPPK' : 'PNS',
                        "TANGGAL LAHIR": new Date(1980 + (i % 20), 0, 1).toISOString(),
                        "PANGKAT / GOL": ['III/a', 'III/b', 'IV/a'][i % 3]
                    }));
                    setData(mock);
                };
                fetchData();
            }, []);

            const stats = useMemo(() => {
                const agg = (key) => {
                    const counts = data.reduce((acc, r) => {
                        const v = r[key];
                        if (v) acc[v] = (acc[v] || 0) + 1;
                        return acc;
                    }, {});
                    return Object.entries(counts).map(([name, value]) => ({ name, value }));
                };
                return {
                    gender: agg('JENIS KELAMIN'),
                    status: agg('STATUS KEPEGAWAIAN'),
                    pangkat: agg('PANGKAT / GOL'),
                    generasi: (() => {
                        const counts = data.reduce((acc, r) => {
                            const g = getGeneration(r['TANGGAL LAHIR']);
                            if (g) acc[g] = (acc[g] || 0) + 1;
                            return acc;
                        }, {});
                        return ['Boomer', 'Gen X', 'Millennial', 'Gen Z'].map(n => ({ name: n, value: counts[n] || 0 })).filter(d => d.value > 0);
                    })()
                };
            }, [data]);

            if (loading) return (
                <div className="flex items-center justify-center h-screen">
                    <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-purple-600"></div>
                </div>
            );

            return (
                <div className="max-w-7xl mx-auto px-4 py-8">
                    <header className="mb-10 flex items-center gap-6">
                        <div className="bg-purple-600 p-4 rounded-2xl shadow-lg">
                            <Icon name="activity" className="text-white w-8 h-8" />
                        </div>
                        <div>
                            <div className="flex items-center gap-2 text-purple-600 font-bold text-xs uppercase mb-1">
                                <Icon name="map-pin" className="w-3 h-3" /> DISDIKPORA DONGGALA
                            </div>
                            <h1 className="text-3xl font-black text-gray-900">HR Analytics Dashboard</h1>
                        </div>
                    </header>

                    <div className="flex gap-2 mb-8 bg-white p-1.5 rounded-2xl w-fit shadow-sm border border-purple-50">
                        {['profil', 'karir'].map(t => (
                            <button key={t} onClick={() => setActiveTab(t)} 
                                className={`px-6 py-2.5 rounded-xl font-bold text-sm transition-all ${activeTab === t ? 'bg-purple-600 text-white shadow-md' : 'text-gray-500 hover:bg-purple-50'}`}>
                                <span className="capitalize">{t} Pegawai</span>
                            </button>
                        ))}
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {activeTab === 'profil' ? (
                            <>
                                <ChartCard title="Jenis Kelamin" desc="Proporsi laki-laki dan perempuan">
                                    <ResponsiveContainer>
                                        <PieChart>
                                            <Pie data={stats.gender} cx="50%" cy="50%" innerRadius={60} outerRadius={100} paddingAngle={5} dataKey="value">
                                                {stats.gender.map((_, i) => <Cell key={i} fill={PIE_COLORS[i % 5]} />)}
                                            </Pie>
                                            <RechartsTooltip />
                                            <Legend verticalAlign="bottom" />
                                        </PieChart>
                                    </ResponsiveContainer>
                                </ChartCard>
                                <ChartCard title="Komposisi Generasi" desc="Berdasarkan kelompok tahun lahir">
                                    <ResponsiveContainer>
                                        <AreaChart data={stats.generasi} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
                                            <XAxis dataKey="name" />
                                            <YAxis />
                                            <RechartsTooltip />
                                            <Area type="monotone" dataKey="value" stroke="#8b5cf6" fill="#ddd6fe" />
                                        </AreaChart>
                                    </ResponsiveContainer>
                                </ChartCard>
                            </>
                        ) : (
                            <>
                                <ChartCard title="Status Kepegawaian" desc="PNS vs PPPK">
                                    <ResponsiveContainer>
                                        <BarChart data={stats.status} layout="vertical" margin={{ left: 20 }}>
                                            <XAxis type="number" />
                                            <YAxis dataKey="name" type="category" width={80} />
                                            <RechartsTooltip />
                                            <Bar dataKey="value" fill="#ec4899" radius={[0, 8, 8, 0]} />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </ChartCard>
                                <ChartCard title="Distribusi Pangkat" desc="Level kepangkatan saat ini">
                                    <ResponsiveContainer>
                                        <BarChart data={stats.pangkat}>
                                            <XAxis dataKey="name" />
                                            <YAxis />
                                            <RechartsTooltip />
                                            <Bar dataKey="value" fill="#8b5cf6" radius={[8, 8, 0, 0]} />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </ChartCard>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
